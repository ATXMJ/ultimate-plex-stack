**Navigation:** [← Previous: Step 17 – Media Processing](17-media-processing.md) | _End_

# Step 17.1: Tdarr Policy & Automation

**Status:** `PLANNED`

This document expands on Step 17 by defining the ongoing Tdarr policy: what to transcode, how aggressively to do it, and how to keep the transcoding pipeline safe for the rest of the stack.

**Design Decision:** Tdarr only runs under the `advanced` Docker Compose profile. All transcoding policies, plugin stacks, and resource limits must be documented and version-controlled so the advanced profile can be started confidently when capacity allows.

**Agent Instructions:** Treat this document as the source of truth for Tdarr library scopes, codec/quality targets, and GPU/CPU usage. Confirm with the user before enabling any automation that could delete or overwrite source files, and prefer test runs on a small sample before applying policies to the full library.

## Objectives

- Define Tdarr library scopes, target codecs, quality thresholds, and acceptable loss profiles.
- Select plugin stacks that implement the desired policies, including audio/subtitle handling.
- Capture GPU/CPU capabilities and express them in `docker-compose.yml` overrides for the `advanced` profile.
- Establish safety valves (queue limits, schedules, health checks) so Tdarr cannot starve Plex or downloader containers.
- Document the apply/verify workflow for Tdarr policy changes.

## Detailed Implementation Steps

1. **Gather Transcoding Requirements** `[PLANNED][PROMPT_USER]`  
   - Confirm which libraries Tdarr is allowed to touch (movies only, TV, both, or specific collections).  
   - Capture user priorities: disk savings vs. visual fidelity, acceptable codecs/containers, languages/subtitle retention.  
   - Record any “never transcode” genres or folders (e.g., 4K HDR masters).  
   - Update the status of this sub-step to `[COMPLETE]`.

2. **Author Policy Matrix** `[PLANNED][PROMPT_USER]`  
   - Produce a table describing source → target transformations (e.g., “1080p H.264 above 12 Mbps → re-encode to H.265 CRF 20, keep Dolby Atmos”).  
   - Specify thresholds for bitrate, resolution, and maximum acceptable filesize reduction per library.  
   - Decide how to treat audio: remove extra tracks? normalize subtitles?  
   - Save the policy matrix in `docs/Transcoding.md` (create if missing) so it is version-controlled.  
   - Update the status of this sub-step to `[COMPLETE]`.

3. **Select & Document Plugin Stack** `[PLANNED][PROMPT_USER]`  
   - Map each row of the policy matrix to specific Tdarr plugins (e.g., “Tdarr_Plugin_QSV_NVENC_HEVC”, “Audio_Remove_LowBitrate”).  
   - Document plugin order, key parameters (CRF/bitrate caps, container format, language filters), and any required Tdarr variables.  
   - Store Tdarr plugin presets/export files under `conf/tdarr/` so they can be restored after container rebuilds.  
   - Update the status of this sub-step to `[COMPLETE]`.

4. **Hardware Acceleration & Compose Updates** `[PLANNED][PROMPT_USER]`  
   - Determine available acceleration (NVIDIA, Intel Quick Sync, AMD) and verify drivers are exposed to Docker Desktop.  
   - Update the `tdarr` service in `docker-compose.yml` (advanced profile) with the necessary device mappings, runtime flags, and environment variables (e.g., `NVIDIA_VISIBLE_DEVICES`, `QSV_DEVICE`).  
   - Document fallback CPU settings if hardware acceleration is unavailable.  
   - Update the status of this sub-step to `[COMPLETE]`.

5. **Resource Governance** `[PLANNED][PROMPT_USER]`  
   - Define safety limits: maximum concurrent transcodes, CPU shares, GPU utilization ceiling, and acceptable schedule windows (e.g., only run overnight).  
   - Configure Tdarr queue settings and, if needed, Docker resource limits to enforce these caps.  
   - Outline monitoring hooks (Tdarr health API, container metrics) and escalation steps if Tdarr backlog grows.  
   - Update the status of this sub-step to `[COMPLETE]`.

6. **Pilot Run & Validation** `[PLANNED][PROMPT_USER]`  
   - Run Tdarr on a small test set (copy of a few files) and verify outputs: quality, audio, subtitles, metadata compatibility with Plex.  
   - Confirm Tdarr respects “do not transcode” folders and that Plex/qBittorrent performance remains unaffected.  
   - Adjust policy matrix or plugin parameters based on findings, then re-import them into Tdarr.  
   - Update the status of this sub-step to `[COMPLETE]`.

7. **Documentation & Completion** `[PLANNED]`  
   - Update `docs/Services.md` with the finalized Tdarr policy summary, plugin stacks, and operational constraints.  
   - If new files were added (e.g., `docs/Transcoding.md`, `conf/tdarr/*`), ensure they are referenced from Step 17.  
   - Once all sub-steps are complete, mark this document `COMPLETE` and update Step 17 to reference it explicitly.  
   - Update the status of this sub-step to `[COMPLETE]`.


